{% extends 'medicines/base.html' %}

{% block title %}QR Code Test Page - MYLE{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-qrcode"></i> QR Code Test Page</h2>
                <a href="{% url 'medicines:home' %}" class="btn btn-secondary">
                    <i class="fas fa-home"></i> Back to Home
                </a>
            </div>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>How to test:</strong> Scan any QR code below with your phone's camera or QR scanner app. 
                You'll be redirected to a beautiful medicine details page.
            </div>
            
            {% if medicines %}
                <div class="row">
                    {% for medicine in medicines %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-pills"></i> {{ medicine.name }}
                                </h6>
                            </div>
                            <div class="card-body text-center">
                                <!-- Generate QR Code -->
                                {% load static %}
                                <div class="qr-code-container mb-3">
                                    {% comment %} We'll generate the QR code inline {% endcomment %}
                                    <div style="background: white; padding: 10px; border-radius: 10px; display: inline-block;">
                                        <img src="data:image/png;base64,{{ medicine.qr_code_base64 }}" 
                                             alt="QR Code for {{ medicine.name }}" 
                                             style="width: 150px; height: 150px;"
                                             id="qr-{{ medicine.pk }}">
                                    </div>
                                </div>
                                
                                <div class="medicine-info">
                                    <p class="mb-1"><strong>Batch:</strong> {{ medicine.batch_number }}</p>
                                    <p class="mb-1"><strong>Manufacturer:</strong> {{ medicine.manufacturer }}</p>
                                    <p class="mb-1"><strong>Exp Date:</strong> {{ medicine.expiry_date|date:"d.m.Y" }}</p>
                                    {% if medicine.mrp %}
                                    <p class="mb-1"><strong>MRP:</strong> â‚¹{{ medicine.mrp }}</p>
                                    {% endif %}
                                </div>
                                
                                <div class="mt-3">
                                    <a href="{{ medicine.get_qr_data }}" 
                                       class="btn btn-sm btn-success" 
                                       target="_blank">
                                        <i class="fas fa-external-link-alt"></i> Test Link
                                    </a>
                                    <a href="{% url 'medicines:qr_code_display' medicine.pk %}" 
                                       class="btn btn-sm btn-info">
                                        <i class="fas fa-eye"></i> View Details
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-warning text-center">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h5>No medicines found!</h5>
                    <p>Create some sample data first to see QR codes.</p>
                    <a href="{% url 'medicines:create_qr' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Medicine
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Generate QR codes dynamically using JavaScript
document.addEventListener('DOMContentLoaded', function() {
    {% for medicine in medicines %}
    generateQRCode('qr-{{ medicine.pk }}', '{{ medicine.get_qr_data }}');
    {% endfor %}
});

function generateQRCode(elementId, url) {
    // Using a simple QR code generation approach
    const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}`;
    const img = document.getElementById(elementId);
    if (img) {
        img.src = qrCodeUrl;
    }
}
</script>
{% endblock %}
